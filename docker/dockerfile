ARG BASE_IMAGE=louislam/uptime-kuma:base2

############################################
# Healthcheck build (Go)
############################################
FROM louislam/uptime-kuma:builder-go AS healthcheck
# already builds /app/extra/healthcheck

############################################
# Node build stage
############################################
FROM node:20-slim AS build
WORKDIR /app

ENV NODE_ENV=production
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1

# Install deps
COPY package.json package-lock.json ./
RUN npm ci --omit=dev && npm cache clean --force

# Copy source
COPY . .

# Copy healthcheck binary
COPY --from=healthcheck /app/extra/healthcheck /app/extra/healthcheck

############################################
# Runtime image (lightweight)
############################################
FROM ${BASE_IMAGE} AS runtime
WORKDIR /app

ENV NODE_ENV=production
ENV UPTIME_KUMA_IS_CONTAINER=1

# Copy only needed files
COPY --from=build --chown=node:node /app /app

EXPOSE 3001
HEALTHCHECK --interval=60s --timeout=30s --start-period=180s --retries=5 CMD extra/healthcheck

ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["node", "server/server.js"]

############################################
# Rootless runtime (optional)
############################################
FROM runtime AS rootless
USER node
